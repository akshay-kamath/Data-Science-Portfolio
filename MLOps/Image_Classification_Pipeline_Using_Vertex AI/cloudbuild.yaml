
# Create config file and build a new image tagged with the given commit hash.

steps:
##Step 1 -> Build main image from Dockerfile
- name: 'gcr.io/cloud-builders/docker'
  id: 'build_image'
  args: [
    'build', '-t', 'us-central1-docker.pkg.dev/qwiklabs-gcp-00-38ed10bd49be/vertex-gar/latest:latest',
    '-f', 'Dockerfile', '.',
  ]

##Step 2 -> Deploy Docker image to Artifact Repository
- name: 'gcr.io/cloud-builders/docker'
  id: 'push_image'
  waitFor:
    - 'build_image'
  args: [
    'push', 'us-central1-docker.pkg.dev/qwiklabs-gcp-00-38ed10bd49be/vertex-gar/latest:latest'
  ]

##Step 3 -> Deploy pipeline to Vertex AI( using above built image )
- name: 'us-central1-docker.pkg.dev/qwiklabs-gcp-00-38ed10bd49be/vertex-gar/latest:latest'
  id: 'deploy_pipelines'
  waitFor:
    - 'push_image'
  entrypoint: /bin/bash
  args:
    - -c
    - |
      python -m build_and_deploy
